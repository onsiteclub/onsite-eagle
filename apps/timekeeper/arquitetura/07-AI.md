# 07 — AI Architecture

**Status:** Implementado (Edge Functions NAO deployadas — chamadas retornam fallback)
**Arquivos:** `src/ai/secretary.ts` (159), `voice.ts` (368), `profile.ts` (113)

---

## @onsite/ai — Package Compartilhado

```
@onsite/ai (package)
  core.ts     -> callAI()
  whisper.ts  -> transcribeAudio()
  types.ts    -> AIRequest, AIResponse
         |
         v
  Supabase Edge Functions
  ai-gateway  -> Rota especialista    STATUS: NAO DEPLOYADO
  ai-whisper  -> OpenAI Whisper       STATUS: NAO DEPLOYADO
```

### callAI()

```typescript
callAI(request: AIRequest, supabaseClient): Promise<AIResponse>
```

Fallback: `{ action: 'error', data: {}, response_text: '...' }`. Non-blocking.

---

## Secretary AI (src/ai/secretary.ts)

### Trigger: Effect AI_CLEANUP (apos confirmExit)

```
cleanupDay(date):
  1. Ler sessions do dia (fechadas, nao deletadas)
  2. SKIP se todas voice/manual
  3. SKIP se < 1 gps/sdk
  4. buildWorkerProfile(30 dias)
  5. callAI({ specialist: 'timekeeper:secretary', context: { mode: 'daily_cleanup', sessions, worker } })
  6. corrections -> editSession(source='secretary')
  7. AI falha -> return 0
```

### Regras do Secretary

- NUNCA tocar source='voice' ou 'manual'
- Sessao > 14h sem break -> exit errado
- Sessao > 12h com break -> overtime real
- Sem break > 7h -> adicionar break avg
- Entry < 4AM -> erro
- Exit > 22PM -> exit perdido
- 2 sessoes mesmo site gap < 30min -> merge

---

## Voice AI (src/ai/voice.ts)

### Pipeline

Mic -> expo-av -> base64 -> transcribeAudio() -> transcript -> processVoiceCommand() -> buildVoiceContext() -> callAI(timekeeper:voice) -> executeVoiceAction() -> use case -> response_text

### 12 Actions

| Action | Executor |
|--------|----------|
| update_record | editSession (voice) |
| delete_record | deleteSession |
| start | createManualSession |
| stop | engine.handleEvent (EXIT) |
| pause/resume | pauseResume |
| query | Read-only |
| send_report | generateReport |
| create/delete_location | manageFence |
| mark_day_type | markAbsence |
| navigate | router.push |

### Contexto enviado ao AI

state (isTracking, site, elapsed), recent_days (7), worker_profile, locations, date_reference_table.

### Crash Risk Conhecido

**voice.ts:273-277** — stop usa type uppercase ('EXIT'), falta fenceId e campos obrigatorios. Deveria usar makeSyntheticEvent().

---

## Worker Profile (src/ai/profile.ts)

30 dias de historico -> avg entry/exit, shift hours, break, pattern.
< 3 sessions -> defaults (07:00/16:00, 8.5h).
pattern: regular (std_dev < 1h), shift_work (bimodal), variable.

### Bug Conhecido

**profile.ts:81** — Referencia `fence_name` (nao existe). Correto: `location_name`.

---

## Custos

| Operacao | Custo |
|----------|-------|
| Voice command | ~$0.02 |
| Secretary/dia | ~$0.10 |
| 10 workers/mes | ~$60 |
| 100 workers/mes | ~$500 |
